#!/bin/sh

# Basic init script for AxNux with Nano-X

# Mount essential filesystems
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev

# Create additional mount points if needed
mkdir -p /tmp /var/log /dev/pts /dev/shm
mount -t tmpfs none /tmp
mount -t devpts devpts /dev/pts
mount -t tmpfs none /dev/shm

# Set up the environment
export PATH=/bin:/sbin:/usr/bin:/usr/sbin
export HOME=/root
export TERM=linux
export NANOWM=1  # Enable Nano-X window manager
export NANOSCREEN=0  # Use screen 0

# Display some debug info
echo "AxNux with Nano-X window manager"
echo "Kernel version: $(uname -a)"

# Debug info about system
echo "--------- SYSTEM INFO -----------------"
echo "PATH: $PATH"
echo "Available executables in /usr/bin/:"
ls -la /usr/bin/nano*
echo "Available executables in /usr/bin/ (nx):"
ls -la /usr/bin/nx*
echo "----------------------------------------"

# Set up framebuffer
if [ -e /dev/fb0 ]; then
    echo "Framebuffer found: /dev/fb0"
    # Set permissions
    chmod 666 /dev/fb0
else
    echo "WARNING: No framebuffer device found! Attempting to create one..."
    mknod /dev/fb0 c 29 0
    chmod 666 /dev/fb0
    echo "Created framebuffer device"
fi

# Start Nano-X window manager
echo "Starting Nano-X window manager..."
if [ -f /usr/bin/nano-X ]; then
    echo "Found nano-X at /usr/bin/nano-X"
    
    # Make sure it's executable
    chmod +x /usr/bin/nano-X
    
    # Run with detailed logging
    echo "Running nano-X..."
    /usr/bin/nano-X -v > /tmp/nanox.log 2>&1 &
    NANO_PID=$!
    echo "Started with PID: $NANO_PID"
    sleep 2
    
    # Check if still running
    if kill -0 $NANO_PID 2>/dev/null; then
        echo "Nano-X started successfully!"
        
        # Try launching a terminal
        if [ -f /usr/bin/nxterm ]; then
            echo "Starting nxterm..."
            /usr/bin/nxterm &
            echo "nxterm started"
        else
            echo "nxterm not found!"
        fi
    else
        echo "Nano-X failed to start!"
        echo "Log output:"
        cat /tmp/nanox.log
    fi
else
    echo "ERROR: nano-X executable not found at /usr/bin/nano-X!"
    echo "Searching for nano-X in other locations:"
    find / -name "nano-X" 2>/dev/null
fi

# Keep init running with a shell for debugging
echo "Starting shell for debugging..."
/bin/sh
