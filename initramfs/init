#!/bin/sh

# Basic init script for AxNux with Nano-X

# Mount essential filesystems
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev

# Set up the environment
export PATH=/bin:/sbin:/usr/bin:/usr/sbin
export HOME=/root
export TERM=linux
export NANOWM=1  # Enable the Nano-X window manager
export NANOSCREEN=0  # Use screen 0

# Create additional mount points if needed
mkdir -p /dev/pts /dev/shm
mount -t devpts devpts /dev/pts
mount -t tmpfs tmpfs /dev/shm

# Display some debug info
echo "AxNux with Nano-X window manager"
echo "Kernel version: $(uname -a)"
echo "Available devices in /dev:"
ls -l /dev
echo "Mounted filesystems:"
mount

# Set up framebuffer
if [ -e /dev/fb0 ]; then
    echo "Framebuffer found: /dev/fb0"
    # Set permissions if needed
    chmod 666 /dev/fb0
else
    echo "WARNING: No framebuffer device found! Creating one..."
    mknod /dev/fb0 c 29 0
    chmod 666 /dev/fb0
fi

# Start Nano-X window manager
echo "Starting Nano-X window manager..."
if [ -x /usr/bin/nano-X ]; then
    # Start nano-X server
    /usr/bin/nano-X -v &
    NANO_X_PID=$!
    sleep 2
    
    # Check if Nano-X started successfully
    if kill -0 $NANO_X_PID 2>/dev/null; then
        echo "Nano-X started successfully with PID $NANO_X_PID"
        
        # Start the launcher which provides a menu of applications
        if [ -x /usr/bin/nxlaunch ]; then
            echo "Starting application launcher..."
            /usr/bin/nxlaunch &
            sleep 1
        fi
        
        # Start terminal with bigger size
        if [ -x /usr/bin/nxterm ]; then
            echo "Starting terminal..."
            /usr/bin/nxterm -geometry 80x25+10+10 &
            sleep 1
        else
            echo "ERROR: nxterm not found!"
        fi
        
        # Start clock
        if [ -x /usr/bin/nxclock ]; then
            echo "Starting clock..."
            /usr/bin/nxclock -geometry +200+10 &
            sleep 1
        fi
        
        # Create a flag file to indicate Nano-X is running
        touch /tmp/nanox_running
        
        # Monitor Nano-X server - restart if it crashes
        while kill -0 $NANO_X_PID 2>/dev/null; do
            sleep 5
        done
        
        echo "Nano-X server exited, restarting..."
        exec /init  # Restart the init script if Nano-X crashes
    else
        echo "ERROR: Nano-X failed to start!"
    fi
else
    echo "ERROR: nano-X not found or not executable!"
    ls -l /usr/bin/nano*
fi

# If we get here, Nano-X failed to start
echo "Starting shell for troubleshooting..."
/bin/sh
